<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Portal - PEC Leave Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">

        <!-- HOD Login -->
        <div id="hodLoginScreen" class="screen">
            <div class="dashboard-header">
                <h2><i class="fas fa-user-tie"></i> HOD Login</h2>
                <a href="index.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>

            <form onsubmit="hodLogin(event)">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Department</label>
                    <select id="hodDept" required>
                        <option value="">Select Department</option>
                        <option value="CSC">Computer Science & Engineering</option>
                        <option value="ECE">Electronics & Communication</option>
                        <option value="CYBER">Cyber Security</option>
                        <option value="AI&ML">Artificial Intelligence & Machine Learning</option>
                        <option value="AL&DS">AI & Data Science</option>
                        <option value="CSBS">Computer Science (Business Systems)</option>
                        <option value="IT">Information Technology</option>
                        <option value="EEE">Electrical & Electronics</option>
                        <option value="MECHANICAL">Mechanical Engineering</option>
                        <option value="BIOTECH">Biotechnology</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> HOD ID</label>
                    <input type="text" id="hodId" placeholder="Enter HOD ID" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="hodPassword" placeholder="Enter password" required>
                </div>

                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>

        <!-- HOD Dashboard -->
        <div id="hodDashboard" class="screen">
            <div class="dashboard-header">
                <h2 id="hodTitle"></h2>
                <div class="user-info">
                    <div class="user-avatar" id="hodAvatar"></div>
                    <button class="btn btn-info" onclick="loadHodRequests(null, true)"
                        style="width:auto; padding:8px 15px;">
                        <i class="fas fa-history"></i> History
                    </button>
                    <button class="btn btn-success" onclick="loadHodRequests(null, false)"
                        style="width:auto; padding:8px 15px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="stats" id="hodStats"></div>

            <div class="menu-bar">
                <input type="date" id="hodFilterDate" onchange="filterHodByDate()">
                <select id="hodFilterYear" onchange="filterHodByYear()">
                    <option value="">All Years</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                <select id="hodFilterStatus" onchange="filterHodByStatus()">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Advisor Approved">Advisor Approved</option>
                    <option value="HOD Approved">HOD Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>

            <div class="table-container">
                <table id="hodTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Year</th>
                            <th>Applied Date</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Reason</th>
                            <th>Email</th>
                            <th>Parent Mobile</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="btn btn-danger logout-btn" onclick="logout('hod')">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

    </div>
    <script src="common.js"></script>
    <script>
        // Constants
        const LOGIN_SCREEN = document.getElementById('hodLoginScreen');
        const DASHBOARD_SCREEN = document.getElementById('hodDashboard');

        window.onload = () => {
            checkLogin();
        };

        const checkLogin = () => {
            const hod = checkAuth('hod');
            if (hod) {
                LOGIN_SCREEN.classList.remove('active');
                DASHBOARD_SCREEN.classList.add('active');
                loadHodData(hod);
            } else {
                LOGIN_SCREEN.classList.add('active');
                DASHBOARD_SCREEN.classList.remove('active');
            }
        };

        // HOD login
        const hodLogin = async (e) => {
            e.preventDefault();
            const dept = document.getElementById('hodDept').value;
            const id = document.getElementById('hodId').value;
            const password = document.getElementById('hodPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/login/staff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'hod', id, password, dept })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('currentHod', JSON.stringify(data));
                    checkLogin();
                    showNotification('Welcome, HOD!', 'success');
                } else {
                    const err = await response.json();
                    showNotification(err.error || 'Invalid credentials', 'error');
                }
            } catch (error) {
                console.error(error);
                showNotification('Network error', 'error');
            }
        };

        // Load data
        const loadHodData = async (hod) => {
            if (document.getElementById('hodTitle')) {
                document.getElementById('hodTitle').textContent = `${hod.dept} - HOD Dashboard`;
            }
            if (document.getElementById('hodAvatar')) {
                document.getElementById('hodAvatar').textContent = hod.name ? hod.name.charAt(0) : 'H';
            }

            loadHodRequests(hod.dept);
            loadAttendanceStats(hod.dept);
        };

        const loadHodRequests = async (dept, showHistory = false) => {
            if (!dept) {
                const hod = checkAuth('hod');
                if (hod) dept = hod.dept;
                else return;
            }

            try {
                // Show buffering/loading state
                const tbody = document.querySelector('#hodTable tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Loading requests...</td></tr>';

                // HOD Sees 'Advisor Approved' by default. If History, fetch ALL for department.
                let url = `${API_BASE_URL}/leaves?dept=${encodeURIComponent(dept)}`;
                if (!showHistory) {
                    url += `&status=Advisor Approved`;
                }

                const response = await fetch(url);
                const leaves = response.ok ? await response.json() : [];

                renderLeavesTable(leaves, showHistory);

                if (showHistory) showNotification('Showing all leave history', 'info');
            } catch (e) {
                console.error(e);
            }
        };

        const loadAttendanceStats = async (dept) => {
            try {
                const response = await fetch(`${API_BASE_URL}/stats/attendance?dept=${encodeURIComponent(dept)}`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('hodStats').innerHTML = `
                        <div class="stat-card">
                          <h3>${stats.total}</h3>
                          <p>Total Students</p>
                        </div>
                        <div class="stat-card">
                          <h3>${stats.present}</h3>
                          <p>Present Today</p>
                        </div>
                        <div class="stat-card" style="border-bottom: 4px solid #e74c3c;">
                          <h3>${stats.onLeave}</h3>
                          <p>On Leave Today</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("Error loading stats", e);
            }
        }

        const renderLeavesTable = (leaves, showHistory) => {
            const tbody = document.querySelector('#hodTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (leaves.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:20px;">No applications found</td></tr>`;
                return;
            }

            leaves.forEach(app => {
                let actionHtml = '';
                // Only show actions if 'Advisor Approved' (Pending HOD action)
                if (app.status === 'Advisor Approved') {
                    actionHtml = `
                        <button class="action-btn approve-btn" onclick="updateStatus('${app._id}', 'HOD Approved')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="action-btn reject-btn" onclick="updateStatus('${app._id}', 'Rejected')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    `;
                } else {
                    actionHtml = `<span style="font-size:0.8rem; color:#7f8c8d;">${app.status === 'HOD Approved' ? 'Approved' : 'Processed'}</span>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${app.regNo}</td>
                    <td>${app.name}</td>
                     <td>${app.year}</td>
                     <td>${app.appliedDate}</td>
                    <td>${app.fromDate}</td>
                    <td>${app.toDate}</td>
                    <td>${app.reason}</td>
                     <td>${app.studentEmail || '-'}</td>
                    <td>${app.parentMobile}</td>
                    <td><span class="status status-${app.status.toLowerCase().replace(' ', '-')}">${app.status}</span></td>
                    <td>${actionHtml}</td>
                `;
                tbody.appendChild(row);
            });
        };

        const updateStatus = async (id, status) => {
            if (!confirm(`Are you sure you want to set status to ${status}?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/leaves/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, role: 'hod' })
                });

                if (response.ok) {
                    showNotification(`Leave ${status}`, 'success');
                    const hod = checkAuth('hod');
                    if (hod) {
                        loadHodRequests(hod.dept);
                        loadAttendanceStats(hod.dept); // Refresh stats as approval changes 'On Leave' count
                    }
                } else {
                    showNotification('Failed to update status', 'error');
                }
            } catch (e) {
                showNotification('Network error', 'error');
            }
        };

        // --- Filter Functions ---
        const filterHodByDate = () => {
            const filterDate = document.getElementById('hodFilterDate').value;
            const rows = document.querySelectorAll('#hodTable tbody tr');

            rows.forEach(row => {
                const rowDate = row.cells[3].textContent; // Applied Date
                if (!filterDate || rowDate === filterDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterHodByYear = () => { /* ... existing logic ... */ };
        const filterHodByStatus = () => { /* ... existing logic ... */ };

    </script>
</body>

</html>