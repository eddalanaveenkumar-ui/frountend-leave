<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advisor Portal - PEC Leave Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">

        <!-- Class Advisor Login -->
        <div id="advisorLoginScreen" class="screen">
            <div class="dashboard-header">
                <h2><i class="fas fa-chalkboard-teacher"></i> Class Advisor Login</h2>
                <a href="index.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>

            <form onsubmit="advisorLogin(event)">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Department</label>
                    <select id="advisorDept" required>
                        <option value="">Select Department</option>
                        <option value="CSC">Computer Science & Engineering</option>
                        <option value="ECE">Electronics & Communication</option>
                        <option value="CYBER">Cyber Security</option>
                        <option value="AI&ML">Artificial Intelligence & Machine Learning</option>
                        <option value="AL&DS">AI & Data Science</option>
                        <option value="CSBS">Computer Science (Business Systems)</option>
                        <option value="IT">Information Technology</option>
                        <option value="EEE">Electrical & Electronics</option>
                        <option value="MECHANICAL">Mechanical Engineering</option>
                        <option value="BIOTECH">Biotechnology</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> Advisor ID</label>
                    <input type="text" id="advisorId" placeholder="Enter advisor ID" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="advisorPassword" placeholder="Enter password" required>
                </div>

                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>

        <!-- Class Advisor Dashboard -->
        <div id="advisorDashboard" class="screen">
            <div class="dashboard-header">
                <h2 id="advisorTitle"></h2>
                <div class="user-info">
                    <div class="user-avatar" id="advisorAvatar"></div>
                    <button class="btn btn-info" onclick="loadAdvisorRequests(null, true)"
                        style="width:auto; padding:8px 15px;">
                        <i class="fas fa-history"></i> History
                    </button>
                    <button class="btn btn-success" onclick="loadAdvisorRequests(null, false)"
                        style="width:auto; padding:8px 15px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="stats" id="advisorStats"></div>

            <div class="menu-bar">
                <input type="date" id="advisorFilterDate" onchange="filterAdvisorByDate()">
                <select id="advisorFilterYear" onchange="filterAdvisorByYear()">
                    <option value="">All Years</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                <select id="advisorFilterStatus" onchange="filterAdvisorByStatus()">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Advisor Approved">Advisor Approved</option>
                    <option value="HOD Approved">HOD Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>

            <div class="table-container">
                <table id="advisorTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Year</th>
                            <th>Applied Date</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Reason</th>
                            <th>Email</th>
                            <th>Parent Mobile</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="btn btn-danger logout-btn" onclick="logout('advisor')">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

    </div>
    <script src="common.js"></script>
    <script>
        // Constants
        const LOGIN_SCREEN = document.getElementById('advisorLoginScreen');
        const DASHBOARD_SCREEN = document.getElementById('advisorDashboard');

        window.onload = () => {
            checkLogin();
        };

        const checkLogin = () => {
            const advisor = checkAuth('advisor');
            if (advisor) {
                LOGIN_SCREEN.classList.remove('active');
                DASHBOARD_SCREEN.classList.add('active');
                loadAdvisorData(advisor);
            } else {
                LOGIN_SCREEN.classList.add('active');
                DASHBOARD_SCREEN.classList.remove('active');
            }
        };

        // Advisor login
        const advisorLogin = async (e) => {
            e.preventDefault();
            const id = document.getElementById('advisorId').value;
            const password = document.getElementById('advisorPassword').value;
            const dept = document.getElementById('advisorDept').value;

            try {
                const response = await fetch(`${API_BASE_URL}/login/staff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'advisor', id, password, dept })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('currentAdvisor', JSON.stringify(data));
                    checkLogin();
                    showNotification(`Welcome, Advisor (${data.dept})!`, 'success');
                } else {
                    const err = await response.json();
                    showNotification(err.error || 'Invalid credentials', 'error');
                }
            } catch (error) {
                console.error(error);
                showNotification('Network error', 'error');
            }
        };

        // Load data
        const loadAdvisorData = async (advisor) => {
            if (document.getElementById('advisorTitle')) {
                document.getElementById('advisorTitle').textContent = `${advisor.dept} - Class Advisor Dashboard`;
            }
            if (document.getElementById('advisorAvatar')) {
                document.getElementById('advisorAvatar').textContent = advisor.name ? advisor.name.charAt(0) : 'A';
            }
            loadAdvisorRequests(advisor.dept);
        };

        const loadAdvisorRequests = async (dept, showHistory = false) => {
            if (!dept) {
                const advisor = checkAuth('advisor');
                if (advisor) dept = advisor.dept;
                else return;
            }

            try {
                // Advisors see 'Pending' by default. If History, fetch ALL for department.
                let url = `${API_BASE_URL}/leaves?dept=${encodeURIComponent(dept)}`;
                if (!showHistory) {
                    url += `&status=Pending`;
                }

                const response = await fetch(url);
                const leaves = response.ok ? await response.json() : [];

                renderStats(leaves.length, showHistory);
                renderLeavesTable(leaves, showHistory);

                if (showHistory) showNotification('Showing all leave history', 'info');
            } catch (e) {
                console.error(e);
            }
        };

        const renderStats = (count, isHistory) => {
            const statsContainer = document.getElementById('advisorStats');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="stat-card">
                      <h3>${count}</h3>
                      <p>${isHistory ? 'Total Records' : 'Pending Requests'}</p>
                    </div>
                  `;
            }
        };

        const renderLeavesTable = (leaves, showHistory) => {
            const tbody = document.querySelector('#advisorTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (leaves.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:20px;">No applications found</td></tr>`;
                return;
            }

            leaves.forEach(app => {
                let actionHtml = '';
                // Only show actions if Pending
                if (app.status === 'Pending') {
                    actionHtml = `
                        <button class="action-btn approve-btn" onclick="updateStatus('${app.id}', 'Advisor Approved')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn reject-btn" onclick="updateStatus('${app.id}', 'Rejected')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    actionHtml = `<span style="font-size:0.8rem; color:#7f8c8d;">Processed</span>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${app.regNo}</td>
                    <td>${app.name}</td>
                     <td>${app.year}</td>
                     <td>${app.appliedDate}</td>
                    <td>${app.fromDate}</td>
                    <td>${app.toDate}</td>
                    <td>${app.reason}</td>
                     <td>${app.studentEmail || '-'}</td>
                    <td>${app.parentMobile}</td>
                    <td><span class="status status-${app.status.toLowerCase().replace(' ', '-')}">${app.status}</span></td>
                    <td>${actionHtml}</td>
                `;
                tbody.appendChild(row);
            });
        };

        const updateStatus = async (id, status) => {
            if (!confirm(`Are you sure you want to set status to ${status}?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/leaves/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, role: 'advisor' })
                });

                if (response.ok) {
                    showNotification(`Leave ${status}`, 'success');
                    const advisor = checkAuth('advisor');
                    if (advisor) loadAdvisorRequests(advisor.dept);
                } else {
                    showNotification('Failed to update status', 'error');
                }
            } catch (e) {
                showNotification('Network error', 'error');
            }
        };

        // Filter functions for advisor (Client side for now)
        const filterAdvisorByDate = () => {
            const filterDate = document.getElementById('advisorFilterDate').value;
            const rows = document.querySelectorAll('#advisorTable tbody tr');

            rows.forEach(row => {
                const rowDate = row.cells[3].textContent; // Applied Date
                if (!filterDate || rowDate === filterDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterAdvisorByYear = () => {
            const filterYear = document.getElementById('advisorFilterYear').value;
            const rows = document.querySelectorAll('#advisorTable tbody tr');

            rows.forEach(row => {
                const year = row.cells[2].textContent;
                if (!filterYear || year.includes(filterYear)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterAdvisorByStatus = () => {
            // Currently only pending is loaded, so this might be redundant unless we load all
        };
    </script>
</body>

</html>