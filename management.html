<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Portal - PEC Leave Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
    <div class="container">

        <!-- Management Login -->
        <div id="managementLoginScreen" class="screen">
            <div class="dashboard-header">
                <h2><i class="fas fa-users-cog"></i> Management Login</h2>
                <a href="index.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>

            <form onsubmit="managementLogin(event)">
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> Management ID</label>
                    <input type="text" id="mUserId" placeholder="Enter management ID" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="mPassword" placeholder="Enter password" required>
                </div>

                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>

        <!-- Management Dashboard -->
        <div id="managementDashboard" class="screen">
            <div class="dashboard-header">
                <h2><i class="fas fa-users-cog"></i> Management Dashboard</h2>
                <div class="user-info">
                    <button class="btn btn-warning" onclick="openScanner()" style="width:auto; padding:8px 15px;">
                        <i class="fas fa-qrcode"></i> Scan QR
                    </button>
                    <button class="btn btn-success" onclick="loadManagementRequests()"
                        style="width:auto; padding:8px 15px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="stats" id="managementStats"></div>

            <div class="menu-bar">
                <select id="managementFilterDept" onchange="filterManagementByDept()">
                    <option value="">All Departments</option>
                    <option value="CSC">CSE</option>
                    <option value="ECE">ECE</option>
                    <option value="CYBER">Cyber Security</option>
                    <option value="AI&ML">AI&ML</option>
                    <option value="AL&DS">AI&DS</option>
                    <option value="CSBS">CSBS</option>
                    <option value="IT">IT</option>
                    <option value="EEE">EEE</option>
                    <option value="MECHANICAL">Mechanical</option>
                    <option value="BIOTECH">Biotech</option>
                </select>
                <select id="managementFilterStatus" onchange="filterManagementByStatus()">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Advisor Approved">Advisor Approved</option>
                    <option value="HOD Approved">HOD Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <input type="date" id="managementFilterDate" onchange="filterManagementByDate()">
            </div>

            <div class="table-container">
                <table id="managementTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Year</th>
                            <th>Applied Date</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Reason</th>
                            <th>Email</th>
                            <th>Parent Mobile</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="btn btn-danger logout-btn" onclick="logout('management')">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Scanner Modal -->
        <div id="scannerModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3><i class="fas fa-qrcode"></i> Scan Student QR</h3>
                    <button class="close-modal" onclick="closeScanner()">&times;</button>
                </div>
                <div id="reader" style="width: 100%;"></div>
                <p style="text-align: center; margin-top: 10px; color: #666;">Point camera at the student's leave pass
                    QR code.</p>
            </div>
        </div>

    </div>
    <script src="common.js"></script>
    <script src="common.js"></script>
    <script>
        // Constants
        const LOGIN_SCREEN = document.getElementById('managementLoginScreen');
        const DASHBOARD_SCREEN = document.getElementById('managementDashboard');

        window.onload = () => {
            checkLogin();
        };

        const checkLogin = () => {
            const user = checkAuth('management');
            if (user) {
                LOGIN_SCREEN.classList.remove('active');
                DASHBOARD_SCREEN.classList.add('active');
                loadManagementDashboard();
            } else {
                LOGIN_SCREEN.classList.add('active');
                DASHBOARD_SCREEN.classList.remove('active');
            }
        };

        // Management login
        const managementLogin = async (e) => {
            e.preventDefault();
            const id = document.getElementById('mUserId').value;
            const password = document.getElementById('mPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/login/staff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'management', id, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('currentManagement', JSON.stringify(data));
                    checkLogin();
                    showNotification('Welcome, Management!', 'success');
                } else {
                    const err = await response.json();
                    showNotification(err.error || 'Invalid credentials', 'error');
                }
            } catch (error) {
                console.error(error);
                showNotification('Network error', 'error');
            }
        };

        // Load management requests
        const loadManagementDashboard = async () => {
            loadAttendanceStats(); // Priority: Global attendance
            loadAllApplications(); // Secondary: List of applications
        };

        const loadAttendanceStats = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/stats/attendance`); // No filter = Global
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('managementStats').innerHTML = `
                        <div class="stat-card">
                          <h3>${stats.total}</h3>
                          <p>Total Students</p>
                        </div>
                        <div class="stat-card">
                          <h3>${stats.present}</h3>
                          <p>Present Today</p>
                        </div>
                        <div class="stat-card" style="border-bottom: 4px solid #e74c3c;">
                          <h3>${stats.onLeave}</h3>
                          <p>On Leave Today</p>
                        </div>
                        <div class="stat-card" style="border-bottom: 4px solid #3498db;">
                            <h3>${stats.date}</h3>
                            <p>Date</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("Stats error", e);
            }
        };

        const loadAllApplications = async () => {
            try {
                // Fetch ALL leaves. Logic might need an endpoint for 'all' or just 'leaves' without filters?
                // The current backend /api/leaves returns all if no filter is provided.
                const response = await fetch(`${API_BASE_URL}/leaves`);
                const applications = response.ok ? await response.json() : [];

                renderTable(applications);

            } catch (e) {
                console.error("Table error", e);
            }
        };

        const renderTable = (applications) => {
            const tbody = document.querySelector('#managementTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (applications.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">No data found</td></tr>`;
                return;
            }

            // Sort by date desc
            applications.sort((a, b) => new Date(b.appliedDate) - new Date(a.appliedDate));

            applications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${app.regNo}</td>
                  <td>${app.name}</td>
                  <td>${app.dept}</td>
                  <td>${app.year}</td>
                  <td>${app.appliedDate}</td>
                  <td>${app.fromDate}</td>
                  <td>${app.toDate}</td>
                  <td>${app.reason}</td>
                  <td>${app.studentEmail || '-'}</td>
                  <td>${app.parentMobile}</td>
                  <td><span class="status status-${app.status.toLowerCase().replace(' ', '-')}">${app.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        };

        // Filter functions for management (Client side)
        const filterManagementByDept = () => {
            const filterDept = document.getElementById('managementFilterDept').value;
            const rows = document.querySelectorAll('#managementTable tbody tr');

            rows.forEach(row => {
                const dept = row.cells[2].textContent;
                if (!filterDept || dept === filterDept) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterManagementByStatus = () => {
            const filterStatus = document.getElementById('managementFilterStatus').value;
            const rows = document.querySelectorAll('#managementTable tbody tr');

            rows.forEach(row => {
                const statusElement = row.cells[10].querySelector('.status');
                const status = statusElement ? statusElement.textContent : '';
                if (!filterStatus || status === filterStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterManagementByDate = () => {
            const filterDate = document.getElementById('managementFilterDate').value;
            const rows = document.querySelectorAll('#managementTable tbody tr');

            rows.forEach(row => {
                const rowDate = row.cells[4].textContent;
                if (!filterDate || rowDate === filterDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // --- Scanner Logic ---
        let html5QrcodeScanner = null;

        const openScanner = () => {
            document.getElementById('scannerModal').classList.add('active');

            // Initialize if not already
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader",
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    /* verbose= */ false
                );
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            }
        };

        const closeScanner = () => {
            document.getElementById('scannerModal').classList.remove('active');
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => {
                    html5QrcodeScanner = null;
                }).catch(error => {
                    console.error("Failed to clear scanner", error);
                });
            }
        };

        function onScanSuccess(decodedText, decodedResult) {
            // Handle the scanned code as you like, for example:
            console.log(`Code matched = ${decodedText}`, decodedResult);

            try {
                const data = JSON.parse(decodedText);
                validateLeavePass(data);
                closeScanner(); // Close scanner on success
            } catch (e) {
                alert("Invalid QR Code Format");
            }
        }

        function onScanFailure(error) {
            // handle scan failure, usually better to ignore and keep scanning.
            // for example:
            // console.warn(`Code scan error = ${error}`);
        }

        const validateLeavePass = (data) => {
            // Logic similar to App
            const now = new Date();
            const approvedTime = new Date(data.approvedAt);
            const timeDiff = now - approvedTime;
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            let message = '';
            let type = 'success';

            if (data.status !== 'HOD Approved') {
                message = `❌ INVALID: Leave is ${data.status} (Not HOD Approved)`;
                type = 'error';
            } else if (hoursDiff > 24) {
                message = `⚠️ EXPIRED: Approved over 24 hours ago.`;
                type = 'warning';
            } else {
                message = `✅ VALID LEAVE PASS\n\nStudent: ${data.name} (${data.regNo})\nDates: ${data.fromDate} to ${data.toDate}`;
                type = 'success';
            }

            // Using our notification system or a simple alert
            if (type === 'success') {
                alert(message); // Simple alert for now to show details clearly
            } else {
                showNotification(message, type);
            }
        };
    </script>
</body>

</html>