<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Portal - PEC Leave Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">

        <!-- HOD Login -->
        <div id="hodLoginScreen" class="screen">
            <div class="dashboard-header">
                <h2><i class="fas fa-user-tie"></i> HOD Login</h2>
                <a href="index.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>

            <form onsubmit="hodLogin(event)">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Department</label>
                    <select id="hodDept" required>
                        <option value="">Select Department</option>
                        <option value="CSC">Computer Science & Engineering</option>
                        <option value="ECE">Electronics & Communication</option>
                        <option value="CYBER">Cyber Security</option>
                        <option value="AI&ML">Artificial Intelligence & Machine Learning</option>
                        <option value="AL&DS">AI & Data Science</option>
                        <option value="CSBS">Computer Science (Business Systems)</option>
                        <option value="IT">Information Technology</option>
                        <option value="EEE">Electrical & Electronics</option>
                        <option value="MECHANICAL">Mechanical Engineering</option>
                        <option value="BIOTECH">Biotechnology</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> HOD ID</label>
                    <input type="text" id="hodId" placeholder="Enter HOD ID" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="hodPassword" placeholder="Enter password" required>
                </div>

                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>

        <!-- HOD Dashboard -->
        <div id="hodDashboard" class="screen">
            <div class="dashboard-header">
                <h2 id="hodTitle"></h2>
                <div class="user-info">
                    <div class="user-avatar" id="hodAvatar"></div>
                    <button class="btn btn-success" onclick="loadHodRequests()" style="width:auto; padding:8px 15px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="stats" id="hodStats"></div>

            <div class="menu-bar">
                <input type="date" id="hodFilterDate" onchange="filterHodByDate()">
                <select id="hodFilterYear" onchange="filterHodByYear()">
                    <option value="">All Years</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                <select id="hodFilterStatus" onchange="filterHodByStatus()">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Advisor Approved">Advisor Approved</option>
                    <option value="HOD Approved">HOD Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>

            <div class="table-container">
                <table id="hodTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Year</th>
                            <th>Applied Date</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Reason</th>
                            <th>Email</th>
                            <th>Parent Mobile</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="btn btn-danger logout-btn" onclick="logout('hod')">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

    </div>
    <script src="common.js"></script>
    <script>
        // Constants
        const LOGIN_SCREEN = document.getElementById('hodLoginScreen');
        const DASHBOARD_SCREEN = document.getElementById('hodDashboard');

        window.onload = () => {
            initializeData();
            checkLogin();
        };

        const checkLogin = () => {
            const hod = checkAuth('hod');
            if (hod) {
                LOGIN_SCREEN.classList.remove('active');
                DASHBOARD_SCREEN.classList.add('active');
                loadHodRequests();
                document.getElementById('hodTitle').textContent = `${hod.dept} - HOD Dashboard`;
                document.getElementById('hodAvatar').textContent = hod.name.charAt(0);
            } else {
                LOGIN_SCREEN.classList.add('active');
                DASHBOARD_SCREEN.classList.remove('active');
            }
        };

        // HOD login
        const hodLogin = (e) => {
            e.preventDefault();
            const dept = document.getElementById('hodDept').value;
            const id = document.getElementById('hodId').value;
            const password = document.getElementById('hodPassword').value;

            const hods = JSON.parse(localStorage.getItem('hods'));
            const hod = hods.find(h => h.dept === dept && h.id === id && h.password === password);

            if (hod) {
                localStorage.setItem('currentHod', JSON.stringify(hod));
                checkLogin();
                showNotification('Welcome, HOD!', 'success');
            } else {
                showNotification('Invalid HOD credentials!', 'error');
            }
        };

        // Load HOD requests
        const loadHodRequests = () => {
            const hod = checkAuth('hod');
            if (!hod) return;

            const applications = JSON.parse(localStorage.getItem('leaveApplications'));
            const hodApplications = applications.filter(app => app.dept === hod.dept && app.status === 'Advisor Approved');

            // Update stats
            document.getElementById('hodStats').innerHTML = `
        <div class="stat-card">
          <h3>${hodApplications.length}</h3>
          <p>Pending Approval</p>
        </div>
        <div class="stat-card">
          <h3>${applications.filter(app => app.dept === hod.dept && app.status === 'HOD Approved').length}</h3>
          <p>Approved by You</p>
        </div>
        <div class="stat-card">
          <h3>${applications.filter(app => app.dept === hod.dept).length}</h3>
          <p>Total Requests</p>
        </div>
      `;

            const tbody = document.querySelector('#hodTable tbody');
            tbody.innerHTML = '';

            if (hodApplications.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="11" style="text-align: center; padding: 40px;">
              <i class="fas fa-check-circle" style="font-size: 3rem; color: #2ecc71; margin-bottom: 20px; display: block;"></i>
              <h3 style="color: #7f8c8d;">No pending requests</h3>
              <p>All requests have been processed</p>
            </td>
          </tr>
        `;
                return;
            }

            hodApplications.sort((a, b) => new Date(b.appliedDate) - new Date(a.appliedDate));

            hodApplications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
          <td>${app.regNo}</td>
          <td>${app.name}</td>
          <td>${app.year}</td>
          <td>${app.appliedDate}</td>
          <td>${app.fromDate}</td>
          <td>${app.toDate}</td>
          <td>${app.reason}</td>
          <td>${app.studentEmail}</td>
          <td>${app.parentMobile}</td>
          <td><span class="status status-pending">${app.status}</span></td>
          <td>
            <button class="action-btn accept-btn" onclick="hodApprove(${app.id})">
              <i class="fas fa-check"></i> Approve
            </button>
            <button class="action-btn reject-btn" onclick="hodReject(${app.id})">
              <i class="fas fa-times"></i> Reject
            </button>
          </td>
        `;
                tbody.appendChild(row);
            });
        };

        // HOD actions
        const hodApprove = (id) => {
            const applications = JSON.parse(localStorage.getItem('leaveApplications'));
            const appIndex = applications.findIndex(app => app.id === id);

            if (appIndex > -1) {
                applications[appIndex].status = 'HOD Approved';
                applications[appIndex].hodAction = new Date().toISOString().split('T')[0];
                localStorage.setItem('leaveApplications', JSON.stringify(applications));
                showNotification('Leave request approved!', 'success');
                loadHodRequests();
            }
        };

        const hodReject = (id) => {
            const applications = JSON.parse(localStorage.getItem('leaveApplications'));
            const appIndex = applications.findIndex(app => app.id === id);

            if (appIndex > -1) {
                applications[appIndex].status = 'Rejected';
                applications[appIndex].hodAction = new Date().toISOString().split('T')[0];
                localStorage.setItem('leaveApplications', JSON.stringify(applications));
                showNotification('Leave request rejected!', 'error');
                loadHodRequests();
            }
        };

        // Filter functions for HOD
        const filterHodByDate = () => {
            const filterDate = document.getElementById('hodFilterDate').value;
            const rows = document.querySelectorAll('#hodTable tbody tr');

            rows.forEach(row => {
                const rowDate = row.cells[3].textContent;
                if (!filterDate || rowDate === filterDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterHodByYear = () => {
            const filterYear = document.getElementById('hodFilterYear').value;
            const rows = document.querySelectorAll('#hodTable tbody tr');

            rows.forEach(row => {
                const year = row.cells[2].textContent;
                if (!filterYear || year.includes(filterYear)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        const filterHodByStatus = () => {
            const filterStatus = document.getElementById('hodFilterStatus').value;
            const rows = document.querySelectorAll('#hodTable tbody tr');

            rows.forEach(row => {
                const statusElement = row.cells[9].querySelector('.status');
                const status = statusElement ? statusElement.textContent : '';
                if (!filterStatus || status === filterStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
    </script>
</body>

</html>